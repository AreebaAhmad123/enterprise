<div class="container mx-auto px-4 py-8">
  <div class="max-w-2xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Payment for <%= @session.title %></h1>

    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <div class="mb-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-2">Session Details</h2>
        <div class="space-y-2">
          <p><span class="font-medium">Consultant:</span> <%= @session.consultant.name %></p>
          <p><span class="font-medium">Date:</span> <%= @session.start_time.strftime("%B %d, %Y") %></p>
          <p><span class="font-medium">Time:</span> <%= @session.start_time.strftime("%I:%M %p") %> - <%= @session.end_time.strftime("%I:%M %p") %></p>
          <p><span class="font-medium">Amount:</span> <%= number_to_currency(@payment.amount) %></p>
        </div>
      </div>

      <%= form_with(model: [@session, @payment], class: "space-y-6") do |form| %>
        <%= form.hidden_field :amount %>
        <%= form.hidden_field :currency %>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Card Information</label>
          <div id="card-element" class="p-3 border border-gray-300 rounded-md"></div>
          <div id="card-errors" class="mt-2 text-sm text-red-600" role="alert"></div>
        </div>

        <div class="flex justify-end">
          <%= form.submit 'Pay Now', class: "bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded", data: { disable_with: 'Processing...' } %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<%= content_for :head do %>
  <script src="https://js.stripe.com/v3/"></script>
<% end %>

<%= content_for :javascript do %>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const stripe = Stripe('<%= Rails.configuration.stripe[:publishable_key] %>');
      const elements = stripe.elements();
      const card = elements.create('card');
      card.mount('#card-element');

      const form = document.querySelector('form');
      const submitButton = form.querySelector('input[type="submit"]');

      card.addEventListener('change', function(event) {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
          displayError.textContent = event.error.message;
        } else {
          displayError.textContent = '';
        }
      });

      form.addEventListener('submit', async function(event) {
        event.preventDefault();
        submitButton.disabled = true;

        const { paymentMethod, error } = await stripe.createPaymentMethod({
          type: 'card',
          card: card,
        });

        if (error) {
          const errorElement = document.getElementById('card-errors');
          errorElement.textContent = error.message;
          submitButton.disabled = false;
        } else {
          const hiddenInput = document.createElement('input');
          hiddenInput.setAttribute('type', 'hidden');
          hiddenInput.setAttribute('name', 'payment_method_id');
          hiddenInput.setAttribute('value', paymentMethod.id);
          form.appendChild(hiddenInput);
          form.submit();
        }
      });
    });
  </script>
<% end %> 