<h1 class="text-2xl font-bold mb-4"><%= @meeting.title %></h1>

<div class="bg-white shadow p-4 rounded">
  <p><strong>Description:</strong> <%= @meeting.description || 'No description provided' %></p>
  <p><strong>Start Time:</strong> <%= @meeting.start_time.strftime('%B %d, %Y at %I:%M %p') %></p>
  <p><strong>End Time:</strong> <%= @meeting.end_time&.strftime('%B %d, %Y at %I:%M %p') || 'Not available' %></p>
  <p><strong>Duration:</strong> <%= @meeting.duration %> minutes</p>
  <p><strong>Status:</strong> <%= @meeting.status.capitalize %></p>
  <p><strong>Client:</strong> <%= @meeting.client&.email || 'Not assigned' %></p>
  <p><strong>Consultant:</strong> <%= @meeting.consultant&.email || 'Not assigned' %></p>
</div>

<% if @meeting.status == 'scheduled' && current_user.client? %>
  <div class="flex gap-4 mt-4">
    <%= link_to 'Pay for Session', pay_meeting_path(@meeting), class: 'bg-green-500 text-white px-4 py-2 rounded' %>
    <%= link_to 'Cancel Session', cancel_meeting_path(@meeting), class: 'bg-red-500 text-white px-4 py-2 rounded' %>
  </div>
<% end %>

<% if @meeting.status == 'pending' && @meeting.client == current_user %>
  <h2 class="text-xl font-semibold mt-6">Complete Payment</h2>
  <%= form_with url: meeting_payments_path(@meeting), local: true, id: "payment-form", class: "mt-4" do |f| %>
    <script src="https://js.stripe.com/v3/"></script>

    <div id="card-element" class="border p-2 rounded"></div>
    <div id="card-errors" class="text-red-600 mt-2"></div>

    <%= hidden_field_tag :stripeToken %>
    <button id="submit" class="bg-green-600 text-white px-4 py-2 rounded mt-4">Pay Now</button>
  <% end %>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const stripe = Stripe('<%= ENV["STRIPE_PUBLISHABLE_KEY"] %>');
      const elements = stripe.elements();
      const card = elements.create('card');
      card.mount('#card-element');

      card.on('change', function(event) {
        document.getElementById('card-errors').textContent = event.error ? event.error.message : '';
      });

      const form = document.getElementById('payment-form');
      form.addEventListener('submit', function(event) {
        event.preventDefault();
        stripe.createToken(card).then(function(result) {
          if (result.error) {
            document.getElementById('card-errors').textContent = result.error.message;
          } else {
            document.querySelector('input[name="stripeToken"]').value = result.token.id;
            form.submit();
          }
        });
      });
    });
  </script>
<% end %>

<h2 class="text-xl font-bold mt-6">Comments</h2>
<div id="comments" class="mt-2">
  <% @meeting.comments.order(created_at: :desc).each do |comment| %>
    <div class="border p-2 mb-2 rounded">
      <p><%= comment.content %></p>
      <p class="text-sm text-gray-500">
        By <%= comment.user.email %> 
        <% if comment.created_at.present? %>
          at <%= comment.created_at.strftime("%b %d, %Y %I:%M %p") %>
        <% end %>
      </p>
    </div>
  <% end %>
</div>

<%= form_with model: [@meeting, Comment.new], url: meeting_comments_path(@meeting), class: "mt-4" do |form| %>
  <div class="mb-4">
    <%= form.label :content, class: "block text-sm font-medium text-gray-700" %>
    <%= form.text_area :content, rows: 4, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
  </div>
  <%= form.submit 'Add Comment', class: 'bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded' %>
<% end %>

<%= link_to 'Back to Meetings', user_meetings_path(@meeting.client), class: 'mt-4 inline-block bg-gray-500 text-white px-4 py-2 rounded' %>